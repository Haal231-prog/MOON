<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Chat</title>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Arial}
#login,#chat{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}
#login{background:linear-gradient(135deg,#00a000,#ff0000,#ffcc00,#0000ff,#ff00ff);background-size:400% 400%;animation:bg 15s infinite}
@keyframes bg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

#messages{flex:1;width:95%;max-width:600px;overflow-y:auto;margin:10px;padding:10px;background:#eee;border-radius:10px}
.message{display:flex;margin:5px;max-width:80%}
.sender{align-self:flex-end;justify-content:flex-end}
.receiver{align-self:flex-start}
.bubble{background:#fff;padding:10px;border-radius:15px;position:relative}
.sender .bubble{background:#dcf8c6}
.quote{font-size:12px;background:#f0f0f0;padding:5px;border-left:3px solid #999;margin-bottom:5px}

.read{font-size:10px;text-align:right;color:gray}

#chat-controls{display:flex;width:95%;max-width:600px;margin-bottom:10px}
#msg{flex:1;padding:10px;border-radius:20px}
button{margin-left:5px;border-radius:20px;padding:10px}

#replyBox{display:none;width:95%;max-width:600px;background:#fff3cd;border-left:4px solid orange;padding:8px;border-radius:8px}
</style>
</head>

<body>

<div id="login">
<h2>Login</h2>
<input id="name" placeholder="Name">
<input id="pin" placeholder="PIN" type="password">
<button onclick="login()">Login</button>
</div>

<div id="chat" style="display:none">
<div id="messages"></div>

<div id="replyBox">
<b id="replyUser"></b>
<div id="replyText"></div>
<button onclick="clearReply()">âœ–</button>
</div>

<div id="chat-controls">
<input id="msg" placeholder="Message" onkeydown="if(event.key==='Enter')sendMessage()">
<button onclick="sendMessage()">Send</button>
<button id="recordBtn">ðŸŽ¤</button>
</div>
</div>

<audio id="notif" src="https://www.soundjay.com/button/sounds/button-10.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyB44cXr29RuwC95yI87FGn1lZnPVKMozRU",
 authDomain:"pvtapp-4d511.firebaseapp.com",
 databaseURL:"https://pvtapp-4d511-default-rtdb.firebaseio.com",
 projectId:"pvtapp-4d511"
});
const db=firebase.database();
const CHAT="shared_chat";

/* GLOBALS */
const PIN="280999";
let user="",replyTo=null;
let recorder,chunks=[];

/* LOGIN */
function login(){
 if(pin.value!==PIN||!name.value)return alert("Invalid");
 user=name.value;
 login.style.display="none";
 chat.style.display="flex";
 listen();
 Notification.requestPermission();
}

/* SEND MESSAGE */
function sendMessage(){
 if(!msg.value)return;
 db.ref(CHAT).push({
  user,
  content:msg.value,
  reply:replyTo,
  read:false,
  type:"text",
  time:Date.now()
 });
 msg.value="";
 clearReply();
}

/* AUDIO */
recordBtn.onclick=async()=>{
 if(!recorder||recorder.state==="inactive"){
  const s=await navigator.mediaDevices.getUserMedia({audio:true});
  recorder=new MediaRecorder(s);chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
   const r=new FileReader();
   r.onload=()=>db.ref(CHAT).push({
    user,type:"audio",content:r.result,reply:replyTo,read:false,time:Date.now()
   });
   r.readAsDataURL(new Blob(chunks));
   clearReply();
  };
  recorder.start();
 }else recorder.stop();
};

/* LISTEN */
function listen(){
 db.ref(CHAT).on("child_added",s=>{
  const m=s.val();
  const div=document.createElement("div");
  div.className="message "+(m.user===user?"sender":"receiver");
  const b=document.createElement("div");
  b.className="bubble";

  if(m.reply){
   const q=document.createElement("div");
   q.className="quote";
   q.innerHTML="<b>"+m.reply.user+"</b>: "+m.reply.content;
   b.appendChild(q);
  }

  if(m.type==="audio"){
   const a=document.createElement("audio");
   a.src=m.content;a.controls=true;
   b.appendChild(a);
  }else b.appendChild(document.createTextNode(m.content));

  /* READ RECEIPT */
  const r=document.createElement("div");
  r.className="read";
  r.innerText=m.read?"âœ”âœ” Read":"âœ” Sent";
  b.appendChild(r);

  /* SWIPE LEFT TO REPLY */
  let x0=0;
  b.ontouchstart=e=>x0=e.touches[0].clientX;
  b.ontouchend=e=>{
   if(x0-e.changedTouches[0].clientX>50){
    replyTo={user:m.user,content:m.content};
    replyBox.style.display="block";
    replyUser.innerText="Reply to "+m.user;
    replyText.innerText=m.content;
   }
  };

  div.appendChild(b);
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;

  if(m.user!==user){
   s.ref.update({read:true});
   notif.play();
   if(Notification.permission==="granted"){
    new Notification("New message",{body:m.content||"Audio message"});
   }
  }
 });
}

/* CLEAR REPLY */
function clearReply(){
 replyTo=null;
 replyBox.style.display="none";
}
</script>
</body>
</html>
