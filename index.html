<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Multi-User Chat</title>

<style>
body, html {
  margin:0;
  padding:0;
  height:100%;
  font-family:Arial,sans-serif;
  font-size:16px;
}

/* LOGIN */
#loginContainer, #chat {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100%;
  width:100%;
}

#loginContainer{
  background: linear-gradient(135deg,#00a000,#ff0000,#ffcc00,#0000ff,#ff00ff);
  background-size:400% 400%;
  animation: rainbowBG 15s ease infinite;
}

@keyframes rainbowBG{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

#loginContainer input,
#loginContainer button{
  padding:12px;
  margin:8px;
  font-size:16px;
  width:80%;
  max-width:300px;
  border-radius:5px;
  border:1px solid #ccc;
}

/* CHAT */
#chat{
  display:none;
  background:#007BFF;
}

#messages{
  flex:1;
  width:100%;
  overflow-y:auto;
  padding:10px;
  background:rgba(240,240,240,0.8);
  display:flex;
  flex-direction:column;
}

.message{
  display:flex;
  width:100%;
  margin:5px 0;
}

.sender{justify-content:flex-end}
.receiver{justify-content:flex-start}

.bubble{
  max-width:70%;
  padding:10px;
  border-radius:20px;
  font-size:16px;
  word-wrap:break-word;
}

.sender .bubble{
  background:#dcf8c6;
  border-top-right-radius:0;
}

.receiver .bubble{
  background:#ffb6c1;
  border-top-left-radius:0;
}

.meta{
  font-size:11px;
  color:#555;
  text-align:right;
  margin-top:4px;
}

#chat-controls{
  display:flex;
  width:95%;
  max-width:600px;
  margin-bottom:10px;
}

#msg{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
}

#sendBtn,#recordBtn{
  padding:10px;
  margin-left:5px;
  border-radius:20px;
  font-size:16px;
}

audio{
  display:block;
  margin-top:5px;
  max-width:100%;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginContainer">
  <h2>Private Login</h2>
  <input id="name" placeholder="Your Name (Mandatory)">
  <input id="pin" placeholder="Enter PIN" type="password">
  <button onclick="handleLogin()">Login</button>
</div>

<!-- CHAT -->
<div id="chat">
  <div id="messages"></div>
  <div id="chat-controls">
    <input id="msg" placeholder="Type a message" 
           onkeydown="if(event.key==='Enter'){sendMessage()}">
    <button id="sendBtn" onclick="sendMessage()">Send</button>
    <button id="recordBtn">ðŸŽ¤</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyB44cXr29RuwC95yI87FGn1lZnPVKMozRU",
  authDomain: "pvtapp-4d511.firebaseapp.com",
  databaseURL: "https://pvtapp-4d511-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* GLOBALS */
const PIN = "280999";
const CHAT_KEY = "shared_chat";
let currentUser = "";
let mediaRecorder;
let audioChunks = [];

/* LOGIN â€” FIXED */
function handleLogin(){
  const n = document.getElementById("name").value.trim();
  const p = document.getElementById("pin").value.trim();

  if(!n || !p){
    alert("Enter name and PIN");
    return;
  }
  if(p !== PIN){
    alert("Wrong PIN");
    return;
  }

  currentUser = n;
  document.getElementById("loginContainer").style.display = "none";
  document.getElementById("chat").style.display = "flex";

  listenMessages();
}

/* SEND TEXT */
function sendMessage(){
  const text = msg.value.trim();
  if(!text) return;

  db.ref(CHAT_KEY).push({
    user: currentUser,
    type: "text",
    content: text,
    timestamp: Date.now(),
    seenBy: {[currentUser]: true}
  });
  msg.value = "";
}

/* AUDIO RECORD */
recordBtn.onclick = async () => {
  if(!mediaRecorder || mediaRecorder.state === "inactive"){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks,{type:"audio/webm"});
      const reader = new FileReader();
      reader.onload = () => {
        db.ref(CHAT_KEY).push({
          user: currentUser,
          type: "audio",
          content: reader.result,
          timestamp: Date.now(),
          seenBy: {[currentUser]: true}
        });
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
  } else {
    mediaRecorder.stop();
  }
};

/* LISTEN */
function listenMessages(){
  db.ref(CHAT_KEY).on("child_added", snap => {
    const msgData = snap.val();
    showMessage(msgData, snap.key);

    if(msgData.user !== currentUser){
      db.ref(CHAT_KEY+"/"+snap.key+"/seenBy/"+currentUser).set(true);
    }
  });
}

/* SHOW MESSAGE */
function showMessage(m, key){
  const div = document.createElement("div");
  const type = m.user === currentUser ? "sender" : "receiver";
  div.className = "message " + type;

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if(m.type === "audio"){
    const audio = document.createElement("audio");
    audio.src = m.content;
    audio.controls = true;
    bubble.appendChild(audio);
  } else {
    bubble.textContent = m.content;
  }

  const meta = document.createElement("div");
  const time = new Date(m.timestamp)
    .toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const seen = (type === "sender" && m.seenBy && Object.keys(m.seenBy).length > 1)
               ? " âœ”âœ”" : (type === "sender" ? " âœ”" : "");
  meta.className = "meta";
  meta.textContent = time + seen;

  bubble.appendChild(meta);
  div.appendChild(bubble);
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}
</script>

</body>
</html>
