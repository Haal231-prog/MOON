<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Chat</title>

<style>
body,html{margin:0;height:100%;font-family:Arial}
#login,#chat{height:100%;display:flex;flex-direction:column}
#login{justify-content:center;align-items:center;background:#222;color:#fff}
#login input,#login button{padding:10px;margin:6px;width:80%;max-width:300px}

#chat{display:none;background:#0a6cff}
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#e5e5e5;
}

.message{display:flex;width:100%;margin:6px 0}
.sender{justify-content:flex-end}
.receiver{justify-content:flex-start}

.bubble{
  max-width:70%;
  padding:10px 12px;
  border-radius:18px;
  font-size:15px;
  position:relative;
}
.sender .bubble{background:#dcf8c6;border-bottom-right-radius:0}
.receiver .bubble{background:#fff;border-bottom-left-radius:0}

.meta{
  font-size:11px;
  color:#555;
  text-align:right;
  margin-top:4px;
}

.controls{
  display:flex;
  padding:8px;
  background:#fff;
}
#msg{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc}
button{margin-left:6px;border-radius:20px;padding:10px}

audio{width:100%;margin-top:5px}
</style>
</head>

<body>

<div id="login">
  <h2>Private Login</h2>
  <input id="name" placeholder="Your name">
  <input id="pin" type="password" placeholder="PIN">
  <button onclick="login()">Login</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <div class="controls">
    <input id="msg" placeholder="Type message" onkeydown="if(event.key==='Enter')sendText()">
    <button onclick="sendText()">Send</button>
    <button id="recBtn">ðŸŽ¤</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyB44cXr29RuwC95yI87FGn1lZnPVKMozRU",
  authDomain: "pvtapp-4d511.firebaseapp.com",
  databaseURL: "https://pvtapp-4d511-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* ---------- GLOBALS ---------- */
const PIN="280999";
let user="";
let recorder, chunks=[];
let recordStart=0;

/* ---------- LOGIN ---------- */
function login(){
  if(pin.value!==PIN||!name.value)return alert("Invalid login");
  user=name.value.trim();
  login.style.display="none";
  chat.style.display="flex";
  listen();
}

/* ---------- SEND TEXT ---------- */
function sendText(){
  if(!msg.value.trim())return;
  send({
    type:"text",
    content:msg.value.trim()
  });
  msg.value="";
}

/* ---------- SEND MESSAGE ---------- */
function send(data){
  db.ref("chat").push({
    user,
    ...data,
    timestamp:Date.now(),
    seenBy:{[user]:true}
  });
}

/* ---------- AUDIO RECORD ---------- */
recBtn.onclick=async()=>{
  if(!recorder||recorder.state==="inactive"){
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(stream);
    chunks=[];
    recordStart=Date.now();
    recBtn.textContent="â¹";
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=()=>{
      const blob=new Blob(chunks,{type:"audio/webm"});
      const r=new FileReader();
      r.onload=()=>send({
        type:"audio",
        content:r.result,
        duration:Math.round((Date.now()-recordStart)/1000)
      });
      r.readAsDataURL(blob);
      recBtn.textContent="ðŸŽ¤";
    };
    recorder.start();
  }else recorder.stop();
};

/* ---------- LISTEN ---------- */
function listen(){
  db.ref("chat").on("child_added",snap=>{
    const m=snap.val();
    const id=snap.key;
    show(m,id);
    if(m.user!==user){
      db.ref(`chat/${id}/seenBy/${user}`).set(true);
    }
  });
}

/* ---------- SHOW MESSAGE ---------- */
function show(m,id){
  const div=document.createElement("div");
  div.className="message "+(m.user===user?"sender":"receiver");

  const b=document.createElement("div");
  b.className="bubble";

  if(m.type==="audio"){
    const a=document.createElement("audio");
    a.src=m.content;
    a.controls=true;
    b.appendChild(a);
  }else b.textContent=m.content;

  const meta=document.createElement("div");
  const time=new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const seen=m.user===user && Object.keys(m.seenBy||{}).length>1 ? "âœ”âœ”":"âœ”";
  meta.className="meta";
  meta.textContent=time+" "+(m.user===user?seen:"");

  b.appendChild(meta);
  div.appendChild(b);
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}
</script>
</body>
</html>
